<policies>
  <inbound>
    <base />

    <!-- Require subscription key (explicit, even though API has it enabled) -->
    <check-header name="Ocp-Apim-Subscription-Key" failed-check-httpcode="401" failed-check-error-message="Missing subscription key">
      <value>*</value>
    </check-header>

    <!-- Rate limiting: 60 calls per minute per subscription -->
    <rate-limit-by-key
      calls="60"
      renewal-period="60"
      counter-key="@(context.Subscription?.Id ?? context.Request.IpAddress)" />

    <!-- Ensure a request ID exists -->
    <set-header name="X-Request-Id" exists-action="override">
      <value>@(context.Request.Headers.ContainsKey("X-Request-Id")
        ? context.Request.Headers["X-Request-Id"].First()
        : context.RequestId)</value>
    </set-header>

    <!-- Forward useful headers to backend -->
    <set-header name="X-Forwarded-For" exists-action="override">
      <value>@(context.Request.IpAddress)</value>
    </set-header>
  </inbound>

  <backend>
    <base />
  </backend>

  <outbound>
    <base />

    <!-- Echo request ID back to client -->
    <set-header name="X-Request-Id" exists-action="override">
      <value>@(context.RequestId)</value>
    </set-header>
  </outbound>

  <on-error>
    <base />
  </on-error>
</policies>
