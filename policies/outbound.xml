<!--
=============================================================================
OUTBOUND POLICY
=============================================================================
Applied to all responses from the backend.
Key principle: PRESERVE BACKEND RESPONSES - no transformation, no swallowing errors.
=============================================================================
-->
<policies>
    <inbound>
        <base />
    </inbound>
    
    <backend>
        <base />
    </backend>
    
    <outbound>
        <!-- Base policy inheritance -->
        <base />
        
        <!-- =================================================================
             REQUEST CORRELATION
             Echo request ID back to client for tracing
             ================================================================= -->
        <set-header name="X-Request-Id" exists-action="override">
            <value>@(context.Request.Headers.GetValueOrDefault("X-Request-Id", ""))</value>
        </set-header>
        
        <!-- =================================================================
             APIM TRACE ID
             Add APIM-specific request ID for gateway-level debugging
             ================================================================= -->
        <set-header name="X-APIM-Request-Id" exists-action="override">
            <value>@(context.RequestId.ToString())</value>
        </set-header>
        
        <!-- =================================================================
             RESPONSE TIMING
             Add processing time header for performance monitoring
             ================================================================= -->
        <set-header name="X-APIM-Processing-Time-Ms" exists-action="override">
            <value>@(context.Elapsed.TotalMilliseconds.ToString("F2"))</value>
        </set-header>
        
        <!-- =================================================================
             SECURITY HEADERS
             Remove internal headers, add security headers
             ================================================================= -->
        <set-header name="X-Content-Type-Options" exists-action="override">
            <value>nosniff</value>
        </set-header>
        <set-header name="X-Frame-Options" exists-action="override">
            <value>DENY</value>
        </set-header>
        
        <!-- Remove APIM internal headers from response -->
        <set-header name="Ocp-Apim-Trace-Location" exists-action="delete" />
        
    </outbound>
    
    <on-error>
        <!-- =================================================================
             ERROR HANDLING
             Preserve backend errors, add correlation IDs for debugging
             ================================================================= -->
        <base />
        
        <!-- Ensure request ID is present in error responses -->
        <set-header name="X-Request-Id" exists-action="override">
            <value>@(context.Request.Headers.GetValueOrDefault("X-Request-Id", context.RequestId.ToString()))</value>
        </set-header>
        <set-header name="X-APIM-Request-Id" exists-action="override">
            <value>@(context.RequestId.ToString())</value>
        </set-header>
        
        <!-- =================================================================
             STRUCTURED ERROR RESPONSE
             Return consistent error format without swallowing details
             ================================================================= -->
        <choose>
            <when condition="@(context.Response == null)">
                <return-response>
                    <set-status code="502" reason="Bad Gateway" />
                    <set-header name="Content-Type" exists-action="override">
                        <value>application/json</value>
                    </set-header>
                    <set-body>@{
                        return new JObject(
                            new JProperty("error", "Bad Gateway"),
                            new JProperty("message", context.LastError.Message),
                            new JProperty("reason", context.LastError.Reason),
                            new JProperty("request_id", context.Request.Headers.GetValueOrDefault("X-Request-Id", context.RequestId.ToString()))
                        ).ToString();
                    }</set-body>
                </return-response>
            </when>
        </choose>
    </on-error>
</policies>
